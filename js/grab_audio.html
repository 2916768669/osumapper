<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta charset="utf-8" />
		<meta name="format-detection" content="telephone=no, email=no, address=no" />
		<title>tensorflow test</title>
		<link rel="stylesheet" type="text/css" href="ar3.css" />
        <script src="ar3.js" type="text/javascript"></script>
        <!-- someone ported numpy to js!!!! -->
        <script src="numjs.min.js" type="text/javascript"></script>
        <script src="osureader.js" type="text/javascript"></script>
		<script src="tf.js" type="text/javascript"></script>
		<script>
		var printedLines = 0;
		function print(...z) {
			if(printedLines > 30) {
				$I("out").value = $I("out").value.split("\n").slice(z.length).join("\n") + "\n" + z.join("    ");
			}
			else if($I("out").value.length == 0 || $I("out").value[$I("out").value.length-1] == "\n") {
				$I("out").value += z.join("    ");
				printedLines += z.length;
			}
			else {
				$I("out").value += "\n" + z.join("    ");
				printedLines += z.length;
			}
		}
		</script>
	</head>
	<body>
		<textarea id="out" style="height: 90%; width: 30%; display:block; position: absolute; top: 10px; left: 10px">
		</textarea>
		<input type="file" id="audio_input" style="margin-left: 50%">
	    <script>
			// const model = tf.sequential({
			// 	layers: [tf.layers.dense({units: 1, inputShape: [10]})]
			// });
			// model.compile({optimizer: 'sgd', loss: function(r, a) {
			// 	return tf.add(tf.square(tf.sub(r, a)), Math.random() * 100);
			// }});
			// async function trainModel() {
			// 	for (let i = 1; i < 500 ; ++i) {
			// 		const h = await model.fit(tf.randomNormal([8, 10]), tf.tensor([[1], [2], [3], [4], [1], [2], [3], [4]]), {
			// 			batchSize: 4,
			// 			epochs: 3
			// 		});
			// 		print("Loss after Epoch " + i + " : " + h.history.loss[0]);
			// 	}
			// }
			// $I("out").value = "";
			// trainModel();
			$I("audio_input").onchange = function() {
				var fp = $I("audio_input").files[0];
				var fr = new FileReader();

				fr.readAsArrayBuffer(fp);
				fr.onload = function() {
					var auc = new AudioContext();
					auc.decodeAudioData(fr.result).then(g);
					print("decode start...");
				};
			}
            setTimeout(function() {
                print("fetch start...");
                fetch("Rakuen PROJECT.ogg", {
                    responseType: "arrayBuffer"
                }).then(z => z.arrayBuffer()).then(z => {
                    var auc = new AudioContext();
                    auc.decodeAudioData(z).then(g);
                    print("fetch OK, decode start...");
                }).catch(e => console.log(e));

                tf.loadModel('lesser-model/model.json').then(model => glob.model = model);
            }, 100);
            // freq_44100[k] at 44100 * k / 64 hz, freq_48000[k'] at 48000 * k' / 64 hz

            // k' = 44100 * k / 48000
			function g(r) {
                print("decode end, processing start...");
                var cdata = r.getChannelData(0);
                var wavData = window.wavData = readWavData([1410, 2510, 3610, 4710, 5810, 6910, 7100, 7500, 7800, 8400, 9000, 9600, 10100, 10600, 11200, 12400], Array.from(cdata), r.sampleRate, 128, [0]);
                // var sliced_cdata = Array.from(cdata.slice(48000 * 30, 48000 * 30 + 64));
                // var dimed_cdata = nj.zeros(sliced_cdata.length);
                // var stacked = nj.stack([sliced_cdata, dimed_cdata]).transpose();
                // var a = nj.fft(stacked);
                // var a1 = a.tolist().map(a => (a[0]**2 + a[1]**2) **0.5);
                // var a2 = new Array(32).fill(0).map((_, i) => i * 44100 / 48000 > 32 ? 0 : interp(a1, i * 44100 / 48000));
                print("processing end, print start...");
                print(nj.array(wavData).shape);
                // print(window.a1 = a1);
                // print(window.a2 = a2);
                const timeInterval = 16;
                wavData = wavData.slice(0, wavData.length - wavData.length % timeInterval);
                print("load model start...");

                var timestamps = [1410, 2510, 3610, 4710, 5810, 6910, 7100, 7500, 7800, 8400, 9000, 9600, 10100, 10600, 11200, 12400];
                var divData = new Array(timeInterval).fill(0).map(() => [0, 0, 1, 0, 0, 0, 0]);

                print("load model end, predict start...");
                predictNotes(timestamps, cdata, divData).then(result => {
                    print(result);
                    window.pred = result;
                    print("predict end");
                }).catch(e => console.log(e));

                // tf.loadModel('lesser-model/model.json').then(model => {
                //     print("load model end, predict start...");
                //     print(nj.array(wavData).shape);
                //     var input1 = nj.reshape(wavData, [wavData.length / timeInterval, timeInterval, 32, 2]).tolist();
                //     var input2 = [new Array(timeInterval).fill(0).map(() => [0, 0, 1, 0, 0, 0, 0])];
                //     var prediction = model.predict([tf.tensor4d(input1), tf.tensor3d(input2)]);
                //     var result = nj.reshape(Array.from(prediction.dataSync()), [timeInterval, 6]);
                //     print(result);
                //     window.pred = prediction;
                //     print("predict end");
                // }).catch(e => console.log(e));
			}
	    </script>

		<script>
			$I("out").value = "";
		</script>
	</body>
</html>